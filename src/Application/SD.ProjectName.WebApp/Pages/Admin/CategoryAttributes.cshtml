@page "/Admin/Categories/{id:int}/Attributes"
@model SD.ProjectName.WebApp.Pages.Admin.CategoryAttributesModel
@removeTagHelper Microsoft.AspNetCore.Mvc.TagHelpers.OptionTagHelper, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Category attributes";
}

<h1>Attributes for @Model.Category?.FullPath</h1>
<p class="text-muted">Define structured attributes for this category. Changes apply to all linked categories sharing the same attribute definition.</p>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert alert-success">@Model.StatusMessage</div>
}

<div asp-validation-summary="All" class="text-danger"></div>

<div class="card mb-4">
    <div class="card-header">Add attribute</div>
    <div class="card-body">
        <form method="post" asp-page-handler="Add">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label asp-for="AddInput.Name" class="form-label"></label>
                    <input asp-for="AddInput.Name" class="form-control" />
                    <span asp-validation-for="AddInput.Name" class="text-danger"></span>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="AddInput.Type" class="form-label"></label>
                    <select asp-for="AddInput.Type" class="form-control">
                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Text">Text</option>
                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Number">Number</option>
                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.List">List</option>
                    </select>
                    <span asp-validation-for="AddInput.Type" class="text-danger"></span>
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-center">
                    <div class="form-check mt-4 pt-1">
                        <input asp-for="AddInput.IsRequired" class="form-check-input" />
                        <label asp-for="AddInput.IsRequired" class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="AddInput.Options" class="form-label"></label>
                    <input asp-for="AddInput.Options" class="form-control" placeholder="For list type: Size, Color" />
                    <span asp-validation-for="AddInput.Options" class="text-danger"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add</button>
            <a asp-page="/Admin/Categories" class="btn btn-link">Back to categories</a>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Link existing attribute</div>
    <div class="card-body">
        @if (Model.LinkableAttributes.Any())
        {
            <form method="post" asp-page-handler="Link" class="form-inline">
                <select asp-for="LinkInput.DefinitionId" class="form-control mr-2" asp-items="Model.LinkableAttributes"></select>
                <button type="submit" class="btn btn-secondary">Link to category</button>
            </form>
        }
        else
        {
            <p class="text-muted mb-0">No other active attributes available to link.</p>
        }
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between">
        <span>Attributes in template</span>
        <small class="text-muted">Shared attributes update all linked categories</small>
    </div>
    <div class="card-body p-0">
        @if (!Model.Attributes.Any())
        {
            <div class="p-3 text-muted">No attributes defined yet.</div>
        }
        else
        {
            <table class="table table-striped mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Required</th>
                        <th>Status</th>
                        <th>Shared with</th>
                        <th style="width: 260px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var attr in Model.Attributes)
                    {
                        var usageCount = attr.Usages?.Count ?? 0;
                        <tr class="@(attr.IsDeprecated ? "table-warning" : string.Empty)">
                            <td>@attr.Name</td>
                            <td>@attr.Type</td>
                            <td>@(attr.IsRequired ? "Yes" : "No")</td>
                            <td>@(attr.IsDeprecated ? "Deprecated" : "Active")</td>
                            <td>@(usageCount > 1 ? $"{usageCount} categories" : "This category")</td>
                            <td>
                                <form method="post" asp-page-handler="Update" class="form-inline mb-2">
                                    <input type="hidden" name="UpdateInput.Id" value="@attr.Id" />
                                    <input name="UpdateInput.Name" class="form-control form-control-sm mr-2" value="@attr.Name" />
                                    <select name="UpdateInput.Type" class="form-control form-control-sm mr-2">
                                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Text" @(attr.Type == SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Text ? "selected=\"selected\"" : string.Empty)>Text</option>
                                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Number" @(attr.Type == SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.Number ? "selected=\"selected\"" : string.Empty)>Number</option>
                                        <option value="@SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.List" @(attr.Type == SD.ProjectName.Modules.Products.Domain.CategoryAttributeTypes.List ? "selected=\"selected\"" : string.Empty)>List</option>
                                    </select>
                                    <div class="form-check form-check-inline mr-2">
                                        <input type="checkbox" class="form-check-input" name="UpdateInput.IsRequired" value="true" @(attr.IsRequired ? "checked" : null) />
                                        <input type="hidden" name="UpdateInput.IsRequired" value="false" />
                                        <label class="form-check-label">Required</label>
                                    </div>
                                    <input name="UpdateInput.Options" class="form-control form-control-sm mr-2" value="@attr.Options" placeholder="List options" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary">Save</button>
                                </form>
                                <form method="post" asp-page-handler="Toggle" class="d-inline">
                                    <input type="hidden" name="ToggleInput.Id" value="@attr.Id" />
                                    <input type="hidden" name="ToggleInput.IsDeprecated" value="@(attr.IsDeprecated ? "false" : "true")" />
                                    <button type="submit" class="btn btn-sm @(attr.IsDeprecated ? "btn-success" : "btn-warning")">
                                        @(attr.IsDeprecated ? "Restore" : "Deprecate")
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>
