@page "/Buyer/Orders/Details/{orderId:int}"
@model SD.ProjectName.WebApp.Pages.Buyer.Orders.DetailsModel
@using SD.ProjectName.WebApp.Services
@{
    ViewData["Title"] = "Order details";
    var order = Model.Order;
    var statusClass = "alert-secondary";
    if (order?.Status != null && order.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-warning";
    }
    else if (order?.Status != null && order.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-info";
    }
    else if (order?.Status != null && order.Status.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-success";
    }
    else if (order?.Status != null && order.Status.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-primary";
    }
}

<h1 class="mb-3">Order details</h1>

@if (order == null)
{
    <div class="alert alert-warning">Order not found or you do not have access to view it.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <div class="fw-semibold">Order #@order.OrderNumber</div>
            <div class="text-muted small">Placed @order.CreatedOn.ToLocalTime().ToString("g")</div>
            <div class="text-muted small">Paid with: @order.PaymentMethodLabel</div>
            @if (!string.IsNullOrWhiteSpace(order.PaymentReference))
            {
                <div class="text-muted small">Payment reference: @order.PaymentReference</div>
            }
        </div>
        <div class="text-end">
            <div class="fw-semibold">@order.GrandTotal.ToString("C")</div>
            <div class="text-muted small">@order.TotalQuantity item(s)</div>
        </div>
    </div>

    <div class="alert @statusClass">
        <div class="fw-semibold mb-1">Overall status: @order.Status</div>
        <div class="mb-0 small text-muted">Sub-order delivery dates and statuses may differ per seller.</div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        <div class="alert alert-success">@Model.StatusMessage</div>
    }

    @if (order.PaymentStatus.Equals(PaymentStatuses.Failed, StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-danger">Payment failed. No charge was captured. Please try again or choose another method.</div>
    }
    else if (order.PaymentStatus.Equals(PaymentStatuses.Pending, StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-info">Payment is pending confirmation. We'll update you once the provider responds.</div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>

    @if (Model.CanSubmitReview)
    {
        var rateableSellers = order.SubOrders
            .Where(s => string.Equals(OrderStatuses.Normalize(s.Status), OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase))
            .ToList();
        var pendingSellerRatings = rateableSellers.Where(s => !Model.SellerRatings.ContainsKey(s.SellerId)).ToList();

        if (rateableSellers.Count > 0)
        {
            <div class="card mb-3">
                <div class="card-header">Rate the seller</div>
                <div class="card-body">
                    @if (pendingSellerRatings.Count > 0)
                    {
                        <form method="post" asp-page-handler="SellerRating" asp-route-orderId="@order.Id">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" asp-for="SellerRatingSellerId">Seller</label>
                                    <select class="form-select" asp-for="SellerRatingSellerId">
                                        @foreach (var sub in pendingSellerRatings)
                                        {
                                            <option value="@sub.SellerId">@sub.SellerName</option>
                                        }
                                    </select>
                                    <span class="text-danger small" asp-validation-for="SellerRatingSellerId"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" asp-for="SellerRatingValue">Rating</label>
                                    <select class="form-select" asp-for="SellerRatingValue">
                                        @for (var i = 5; i >= 1; i--)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                    <span class="text-danger small" asp-validation-for="SellerRatingValue"></span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary btn-sm">Submit seller rating</button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">You rated all sellers for this order. Thank you!</div>
                    }
                </div>
            </div>
        }

        <div class="card mb-3">
            <div class="card-header">Share your review</div>
            <div class="card-body">
                <form method="post" asp-page-handler="Review" asp-route-orderId="@order.Id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" asp-for="ReviewProductId">Product</label>
                            <select class="form-select" asp-for="ReviewProductId">
                                @foreach (var item in order.Items)
                                {
                                    <option value="@item.ProductId">@item.Name</option>
                                }
                            </select>
                            <span class="text-danger small" asp-validation-for="ReviewProductId"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" asp-for="ReviewRating">Rating</label>
                            <select class="form-select" asp-for="ReviewRating">
                                @for (var i = 5; i >= 1; i--)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                            <span class="text-danger small" asp-validation-for="ReviewRating"></span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label" asp-for="ReviewContent">Feedback</label>
                        <textarea class="form-control" asp-for="ReviewContent" rows="3" placeholder="Share details that help other buyers."></textarea>
                        <span class="text-danger small" asp-validation-for="ReviewContent"></span>
                        <div class="form-text">Reviews are rate limited to prevent spam. Keep feedback constructive.</div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">Submit review</button>
                    </div>
                </form>
            </div>
        </div>
    }
    else if (order.Status.Equals(OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase) == false)
    {
        <div class="alert alert-info">You can leave a review after this order is marked delivered.</div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">Items by seller</div>
                <div class="card-body">
                    @if (order.SubOrders != null && order.SubOrders.Count > 0)
                    {
                        foreach (var sub in order.SubOrders)
                        {
                            var trackingLink = string.IsNullOrWhiteSpace(sub.TrackingUrl)
                                ? Model.BuildTrackingLink(sub.TrackingNumber, sub.TrackingCarrier)
                                : sub.TrackingUrl;
                            <div class="border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <div class="fw-semibold">@sub.SellerName</div>
                                        <div class="text-muted small">Sub-order @sub.SubOrderNumber</div>
                                        @{
                                            var normalizedSubStatus = OrderStatuses.Normalize(sub.Status);
                                            var subStatusBadge = "bg-secondary";
                                            var hasSellerRating = Model.SellerRatings.TryGetValue(sub.SellerId, out var sellerRating);
                                            if (normalizedSubStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-success";
                                            }
                                            else if (normalizedSubStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-primary";
                                            }
                                            else if (normalizedSubStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-info text-dark";
                                            }
                                            else if (normalizedSubStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-warning text-dark";
                                            }
                                            else if (normalizedSubStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-light text-dark border";
                                            }
                                        }
                                        <div class="text-muted small">
                                            Status:
                                            <span class="badge @subStatusBadge">@normalizedSubStatus</span>
                                            @if (string.Equals(normalizedSubStatus, OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase) && sub.DeliveredOn.HasValue)
                                            {
                                                <span class="text-success ms-1">Delivered @sub.DeliveredOn.Value.ToLocalTime().ToString("g")</span>
                                            }
                                        </div>
                                        @if (hasSellerRating)
                                        {
                                            <div class="text-warning small">Your rating: @sellerRating/5</div>
                                        }
                                        <div class="text-muted small">Shipping: @sub.ShippingDetail.MethodLabel (@sub.ShippingDetail.Cost.ToString("C"))</div>
                                        @{
                                            var estimate = string.IsNullOrWhiteSpace(sub.ShippingDetail.DeliveryEstimate)
                                                ? sub.ShippingDetail.Description
                                                : sub.ShippingDetail.DeliveryEstimate;
                                        }
                                        @if (!string.IsNullOrWhiteSpace(estimate))
                                        {
                                            <div class="text-muted small">Estimated: @estimate</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(sub.ShippingDetail.Description) && !string.Equals(sub.ShippingDetail.Description, estimate, StringComparison.Ordinal))
                                        {
                                            <div class="text-muted small">@sub.ShippingDetail.Description</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(sub.TrackingNumber) || !string.IsNullOrWhiteSpace(trackingLink))
                                        {
                                            if (!string.IsNullOrWhiteSpace(trackingLink))
                                            {
                                                <div class="small">
                                                    <a href="@trackingLink" target="_blank" rel="noopener">Tracking: @(string.IsNullOrWhiteSpace(sub.TrackingNumber) ? "View shipment" : sub.TrackingNumber)</a>
                                                    @if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                                    {
                                                        <span class="text-muted"> • @sub.TrackingCarrier</span>
                                                    }
                                                </div>
                                            }
                                            else if (!string.IsNullOrWhiteSpace(sub.TrackingNumber))
                                            {
                                                <div class="text-muted small">
                                                    Tracking: @sub.TrackingNumber
                                                    @if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                                    {
                                                        <span> • @sub.TrackingCarrier</span>
                                                        <span class="ms-1">(track on the carrier site)</span>
                                                    }
                                                </div>
                                            }
                                        }
                                        else if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                        {
                                            <div class="text-muted small">Carrier: @sub.TrackingCarrier</div>
                                        }
                                        @if (sub.RefundedAmount > 0 || sub.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase) || sub.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <div class="text-danger small">
                                                @if (sub.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span>Cancelled</span>
                                                }
                                                else if (sub.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span>Refunded</span>
                                                }
                                                @if (sub.RefundedAmount > 0)
                                                {
                                                    <span> • Amount: @sub.RefundedAmount.ToString("C")</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@sub.GrandTotal.ToString("C")</div>
                                        <div class="text-muted small">@sub.TotalQuantity item(s)</div>
                                        @if (sub.DiscountTotal > 0)
                                        {
                                            <div class="text-success small">Discount -@sub.DiscountTotal.ToString("C")</div>
                                        }
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="fw-semibold mb-1">Messages</div>
                                    @{
                                        var thread = order.Messages?
                                            .Where(m => string.Equals(m.SubOrderNumber, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase))
                                            .OrderBy(m => m.SentOn)
                                            .ToList() ?? new List<OrderMessage>();
                                    }
                                    <div class="border rounded p-2 bg-light">
                                        @if (thread.Any())
                                        {
                                            foreach (var msg in thread)
                                            {
                                                <div class="mb-2">
                                                    <div class="small text-muted">@msg.SentOn.ToLocalTime().ToString("g") • @msg.SenderRole</div>
                                                    <div>@msg.Message</div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-muted small">No messages yet.</div>
                                        }
                                        <form method="post" asp-page-handler="Message" asp-route-orderId="@order.Id">
                                            <input type="hidden" asp-for="MessageSubOrder" value="@sub.SubOrderNumber" />
                                            <div class="mt-2">
                                                <label class="form-label small" for="message-content-@sub.SubOrderNumber">Send a message</label>
                                                <textarea class="form-control form-control-sm" id="message-content-@sub.SubOrderNumber" asp-for="MessageContent" rows="2" placeholder="Ask the seller about this sub-order"></textarea>
                                                <span class="text-danger small" asp-validation-for="MessageContent"></span>
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-outline-primary mt-2">Send</button>
                                        </form>
                                    </div>
                                </div>
                                @if (sub.Return != null)
                                {
                                    var returnItems = sub.Return.Items.Select(i =>
                                    {
                                        var match = sub.Items.FirstOrDefault(si => si.ProductId == i.ProductId);
                                        var label = match == null ? "Item" : match.Name;
                                        return $"{i.Quantity} x {label}";
                                    });
                                    <div class="alert alert-info py-2 px-3 mb-3">
                                        <div class="fw-semibold mb-1">@sub.Return.Type request @sub.Return.Status</div>
                                        @if (!string.IsNullOrWhiteSpace(sub.Return.CaseId))
                                        {
                                            <div class="text-muted small mb-1">Case ID: @sub.Return.CaseId</div>
                                        }
                                        <div class="text-muted small mb-1">Requested @sub.Return.RequestedOn.ToLocalTime().ToString("g")</div>
                                        <div class="small mb-1">Reason: @sub.Return.Reason</div>
                                        @if (!string.IsNullOrWhiteSpace(sub.Return.Description))
                                        {
                                            <div class="small mb-1">Description: @sub.Return.Description</div>
                                        }
                                        <div class="small mb-0">Items: @string.Join(", ", returnItems)</div>
                                    </div>
                                }
                                else if (Model.CanRequestReturn(sub))
                                {
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="fw-semibold mb-2">Request support</div>
                                        <div class="text-muted small mb-2">Submit a return or complaint for delivered items. Returns are available within @Model.ReturnWindowDays days of delivery.</div>
                                        <form method="post" asp-page-handler="Return" asp-route-orderId="@order.Id">
                                            <input type="hidden" name="ReturnSubOrder" value="@sub.SubOrderNumber" />
                                            <div class="mb-2">
                                                <label class="form-label" for="return-type-@sub.SubOrderNumber">Request type</label>
                                                @{
                                                    var selectedType = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) && !string.IsNullOrWhiteSpace(Model.ReturnType)
                                                        ? Model.ReturnType
                                                        : ReturnRequestTypes.Return;
                                                }
                                                <select class="form-select form-select-sm" id="return-type-@sub.SubOrderNumber" name="ReturnType">
                                                    <option value="@ReturnRequestTypes.Return" selected="@(string.Equals(selectedType, ReturnRequestTypes.Return, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">Return</option>
                                                    <option value="@ReturnRequestTypes.Complaint" selected="@(string.Equals(selectedType, ReturnRequestTypes.Complaint, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">Complaint</option>
                                                </select>
                                                <div class="form-text">Returns limited to @Model.ReturnWindowDays days after delivery; complaints can be filed for any delivered order.</div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="form-text">Select items for this case (leave unchecked to include the entire sub-order).</div>
                                                @foreach (var item in sub.Items)
                                                {
                                                    var checkboxId = $"return-{sub.SubOrderNumber}-{item.ProductId}";
                                                    var isChecked = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) && Model.ReturnItems != null && Model.ReturnItems.Contains(item.ProductId);
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="ReturnItems" value="@item.ProductId" id="@checkboxId" @(isChecked ? "checked" : string.Empty) />
                                                        <label class="form-check-label" for="@checkboxId">
                                                            @item.Name <span class="text-muted small">x@item.Quantity</span>
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="return-reason-@sub.SubOrderNumber">Reason</label>
                                                @{
                                                    var existingReason = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) ? Model.ReturnReason : string.Empty;
                                                }
                                                <textarea class="form-control" id="return-reason-@sub.SubOrderNumber" name="ReturnReason" rows="3">@existingReason</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="return-description-@sub.SubOrderNumber">Description</label>
                                                @{
                                                    var existingDescription = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) ? Model.ReturnDescription : string.Empty;
                                                }
                                                <textarea class="form-control" id="return-description-@sub.SubOrderNumber" name="ReturnDescription" rows="3">@existingDescription</textarea>
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Submit request</button>
                                        </form>
                                    </div>
                                }
                                else if (string.Equals(OrderStatuses.Normalize(sub.Status), OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase))
                                {
                                    <div class="text-muted small mb-3">Support case not available for this sub-order.</div>
                                }
                                <div class="table-responsive">
                                    <table class="table align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col">Item</th>
                                                <th scope="col">Status</th>
                                                <th scope="col" class="text-end">Qty</th>
                                                <th scope="col" class="text-end">Unit</th>
                                                <th scope="col" class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in sub.Items)
                                            {
                                                var itemStatus = OrderStatuses.Normalize(item.Status);
                                                var badgeClass = "bg-secondary";
                                                if (itemStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-success";
                                                }
                                                else if (itemStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-primary";
                                                }
                                                else if (itemStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-info text-dark";
                                                }
                                                else if (itemStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-warning text-dark";
                                                }
                                                else if (itemStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-light text-dark border";
                                                }
                                                <tr>
                                                    <td>
                                                        <div class="fw-semibold">@item.Name</div>
                                                        @if (!string.IsNullOrWhiteSpace(item.Variant))
                                                        {
                                                            <div class="text-muted small">@item.Variant</div>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge @badgeClass">@itemStatus</span>
                                                    </td>
                                                    <td class="text-end">@item.Quantity</td>
                                                    <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                    <td class="text-end">@item.LineTotal.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    }
                    else if (order.Items != null && order.Items.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col">Item</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Seller</th>
                                        <th scope="col" class="text-end">Qty</th>
                                        <th scope="col" class="text-end">Unit</th>
                                        <th scope="col" class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in order.Items)
                                    {
                                        var itemStatus = OrderStatuses.Normalize(item.Status);
                                        var badgeClass = "bg-secondary";
                                        if (itemStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-success";
                                        }
                                        else if (itemStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-primary";
                                        }
                                        else if (itemStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-info text-dark";
                                        }
                                        else if (itemStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-warning text-dark";
                                        }
                                        else if (itemStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-light text-dark border";
                                        }
                                        <tr>
                                            <td>
                                                <div class="fw-semibold">@item.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(item.Variant))
                                                {
                                                    <div class="text-muted small">@item.Variant</div>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @badgeClass">@itemStatus</span>
                                            </td>
                                            <td>@item.SellerName</td>
                                            <td class="text-end">@item.Quantity</td>
                                            <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                            <td class="text-end">@item.LineTotal.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">Item details are not available.</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Delivery address</div>
                <div class="card-body">
                    @if (order.Address != null)
                    {
                        <div class="fw-semibold">@order.Address.Recipient</div>
                        <div>@order.Address.Line1</div>
                        @if (!string.IsNullOrWhiteSpace(order.Address.Line2))
                        {
                            <div>@order.Address.Line2</div>
                        }
                        <div>@order.Address.City @order.Address.State @order.Address.PostalCode</div>
                        <div>@order.Address.Country</div>
                        @if (!string.IsNullOrWhiteSpace(order.Address.Phone))
                        {
                            <div class="text-muted">Phone: @order.Address.Phone</div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">Address not available.</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Returns & support</div>
                <div class="card-body">
                    <div class="mb-2">You can submit a return or complaint for delivered items. Returns are available within @Model.ReturnWindowDays days of delivery.</div>
                    @if (order.SubOrders != null && order.SubOrders.Any(s => s.Return != null))
                    {
                        var caseSummaries = order.SubOrders
                            .Where(s => s.Return != null)
                            .Select(s =>
                            {
                                var caseId = string.IsNullOrWhiteSpace(s.Return!.CaseId) ? "case" : s.Return.CaseId;
                                return $"{s.SubOrderNumber} • {s.Return!.Type} • {s.Return!.Status} ({caseId})";
                            });
                        <div class="small mb-0">Cases: @string.Join("; ", caseSummaries)</div>
                    }
                    else
                    {
                        <div class="text-muted small mb-0">Use the \"Request support\" option under a delivered sub-order above.</div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">Totals</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Items subtotal</span>
                        <span>@order.ItemsSubtotal.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span>@order.ShippingTotal.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 @(order.DiscountTotal > 0 ? string.Empty : "d-none")">
                        <span>Discount <span class="text-muted">@((order.PromoCode ?? string.Empty) == string.Empty ? string.Empty : $"({order.PromoCode})")</span></span>
                        <span>-@order.DiscountTotal.ToString("C")</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <strong>Total</strong>
                        <strong>@order.GrandTotal.ToString("C")</strong>
                    </div>
                    <div class="text-muted small mt-2">@order.TotalQuantity item(s)</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Payment</div>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="fw-semibold">Status</div>
                        @{
                            var paymentBadge = "bg-secondary";
                            if (order.PaymentStatus.Equals(PaymentStatuses.Paid, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-success";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Pending, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-warning text-dark";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Failed, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-danger";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Refunded, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-info text-dark";
                            }
                        }
                        <span class="badge @paymentBadge">@order.PaymentStatus</span>
                        @if (!string.IsNullOrWhiteSpace(order.PaymentStatusMessage))
                        {
                            <div class="text-muted small mt-1">@order.PaymentStatusMessage</div>
                        }
                    </div>
                    <div class="mb-2">
                        <div class="fw-semibold">Method</div>
                        <div class="text-muted">@order.PaymentMethodLabel</div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(order.PaymentReference))
                    {
                        <div class="mb-2">
                            <div class="fw-semibold">Reference</div>
                            <div class="text-muted">@order.PaymentReference</div>
                        </div>
                    }
                    @if (order.PaymentRefundedAmount > 0)
                    {
                        <div class="mb-2 text-danger">
                            <div class="fw-semibold">Refunded</div>
                            <div class="text-muted">@order.PaymentRefundedAmount.ToString("C")</div>
                        </div>
                    }
                    <div class="mb-0">
                        <div class="fw-semibold">Order ID</div>
                        <div class="text-muted">@order.OrderNumber</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-outline-secondary" asp-page="/Buyer/Orders/Index">Back to orders</a>
    </div>
}
