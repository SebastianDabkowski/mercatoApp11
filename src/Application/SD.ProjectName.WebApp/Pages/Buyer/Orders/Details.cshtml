@page "/Buyer/Orders/Details/{orderId:int}"
@model SD.ProjectName.WebApp.Pages.Buyer.Orders.DetailsModel
@using SD.ProjectName.WebApp.Services
@{
    ViewData["Title"] = "Order details";
    var order = Model.Order;
    var statusClass = "alert-secondary";
    if (order?.Status != null && order.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-warning";
    }
    else if (order?.Status != null && order.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-info";
    }
    else if (order?.Status != null && order.Status.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-success";
    }
    else if (order?.Status != null && order.Status.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
    {
        statusClass = "alert-primary";
    }
}

<h1 class="mb-3">Order details</h1>

@if (order == null)
{
    <div class="alert alert-warning">Order not found or you do not have access to view it.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <div class="fw-semibold">Order #@order.OrderNumber</div>
            <div class="text-muted small">Placed @order.CreatedOn.ToLocalTime().ToString("g")</div>
            <div class="text-muted small">Paid with: @order.PaymentMethodLabel</div>
            @if (!string.IsNullOrWhiteSpace(order.PaymentReference))
            {
                <div class="text-muted small">Payment reference: @order.PaymentReference</div>
            }
        </div>
        <div class="text-end">
            <div class="fw-semibold">@order.GrandTotal.ToString("C")</div>
            <div class="text-muted small">@order.TotalQuantity item(s)</div>
        </div>
    </div>

    <div class="alert @statusClass">
        <div class="fw-semibold mb-1">Overall status: @order.Status</div>
        <div class="mb-0 small text-muted">Sub-order delivery dates and statuses may differ per seller.</div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        <div class="alert alert-success">@Model.StatusMessage</div>
    }

    @if (order.PaymentStatus.Equals(PaymentStatuses.Failed, StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-danger">Payment failed. No charge was captured. Please try again or choose another method.</div>
    }
    else if (order.PaymentStatus.Equals(PaymentStatuses.Pending, StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-info">Payment is pending confirmation. We'll update you once the provider responds.</div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">Items by seller</div>
                <div class="card-body">
                    @if (order.SubOrders != null && order.SubOrders.Count > 0)
                    {
                        foreach (var sub in order.SubOrders)
                        {
                            var trackingLink = Model.BuildTrackingLink(sub.TrackingNumber, sub.TrackingCarrier);
                            <div class="border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <div class="fw-semibold">@sub.SellerName</div>
                                        <div class="text-muted small">Sub-order @sub.SubOrderNumber</div>
                                        @{
                                            var normalizedSubStatus = OrderStatuses.Normalize(sub.Status);
                                            var subStatusBadge = "bg-secondary";
                                            if (normalizedSubStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-success";
                                            }
                                            else if (normalizedSubStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-primary";
                                            }
                                            else if (normalizedSubStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-info text-dark";
                                            }
                                            else if (normalizedSubStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-warning text-dark";
                                            }
                                            else if (normalizedSubStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                            {
                                                subStatusBadge = "bg-light text-dark border";
                                            }
                                        }
                                        <div class="text-muted small">
                                            Status:
                                            <span class="badge @subStatusBadge">@normalizedSubStatus</span>
                                            @if (string.Equals(normalizedSubStatus, OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase) && sub.DeliveredOn.HasValue)
                                            {
                                                <span class="text-success ms-1">Delivered @sub.DeliveredOn.Value.ToLocalTime().ToString("g")</span>
                                            }
                                        </div>
                                        <div class="text-muted small">Shipping: @sub.ShippingDetail.MethodLabel (@sub.ShippingDetail.Cost.ToString("C"))</div>
                                        @{
                                            var estimate = string.IsNullOrWhiteSpace(sub.ShippingDetail.DeliveryEstimate)
                                                ? sub.ShippingDetail.Description
                                                : sub.ShippingDetail.DeliveryEstimate;
                                        }
                                        @if (!string.IsNullOrWhiteSpace(estimate))
                                        {
                                            <div class="text-muted small">Estimated: @estimate</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(sub.ShippingDetail.Description) && !string.Equals(sub.ShippingDetail.Description, estimate, StringComparison.Ordinal))
                                        {
                                            <div class="text-muted small">@sub.ShippingDetail.Description</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(sub.TrackingNumber))
                                        {
                                            if (!string.IsNullOrWhiteSpace(trackingLink))
                                            {
                                                <div class="small">
                                                    <a href="@trackingLink" target="_blank" rel="noopener">Tracking: @sub.TrackingNumber</a>
                                                    @if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                                    {
                                                        <span class="text-muted"> • @sub.TrackingCarrier</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-muted small">
                                                    Tracking: @sub.TrackingNumber
                                                    @if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                                    {
                                                        <span> • @sub.TrackingCarrier</span>
                                                        <span class="ms-1">(track on the carrier site)</span>
                                                    }
                                                </div>
                                            }
                                        }
                                        else if (!string.IsNullOrWhiteSpace(sub.TrackingCarrier))
                                        {
                                            <div class="text-muted small">Carrier: @sub.TrackingCarrier</div>
                                        }
                                        @if (sub.RefundedAmount > 0 || sub.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase) || sub.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <div class="text-danger small">
                                                @if (sub.Status.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span>Cancelled</span>
                                                }
                                                else if (sub.Status.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span>Refunded</span>
                                                }
                                                @if (sub.RefundedAmount > 0)
                                                {
                                                    <span> • Amount: @sub.RefundedAmount.ToString("C")</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@sub.GrandTotal.ToString("C")</div>
                                        <div class="text-muted small">@sub.TotalQuantity item(s)</div>
                                        @if (sub.DiscountTotal > 0)
                                        {
                                            <div class="text-success small">Discount -@sub.DiscountTotal.ToString("C")</div>
                                        }
                                    </div>
                                </div>
                                @if (sub.Return != null)
                                {
                                    var returnItems = sub.Return.Items.Select(i =>
                                    {
                                        var match = sub.Items.FirstOrDefault(si => si.ProductId == i.ProductId);
                                        var label = match == null ? "Item" : match.Name;
                                        return $"{i.Quantity} x {label}";
                                    });
                                    <div class="alert alert-info py-2 px-3 mb-3">
                                        <div class="fw-semibold mb-1">Return @sub.Return.Status</div>
                                        <div class="text-muted small mb-1">Requested @sub.Return.RequestedOn.ToLocalTime().ToString("g")</div>
                                        <div class="small mb-1">Reason: @sub.Return.Reason</div>
                                        <div class="small mb-0">Items: @string.Join(", ", returnItems)</div>
                                    </div>
                                }
                                else if (Model.CanRequestReturn(sub))
                                {
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="fw-semibold mb-2">Request a return</div>
                                        <div class="text-muted small mb-2">Return requests are available within @Model.ReturnWindowDays days of delivery.</div>
                                        <form method="post" asp-page-handler="Return" asp-route-orderId="@order.Id">
                                            <input type="hidden" name="ReturnSubOrder" value="@sub.SubOrderNumber" />
                                            <div class="mb-2">
                                                <div class="form-text">Select items to return (leave unchecked to return the entire sub-order).</div>
                                                @foreach (var item in sub.Items)
                                                {
                                                    var checkboxId = $"return-{sub.SubOrderNumber}-{item.ProductId}";
                                                    var isChecked = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) && Model.ReturnItems != null && Model.ReturnItems.Contains(item.ProductId);
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="ReturnItems" value="@item.ProductId" id="@checkboxId" @(isChecked ? "checked" : string.Empty) />
                                                        <label class="form-check-label" for="@checkboxId">
                                                            @item.Name <span class="text-muted small">x@item.Quantity</span>
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="return-reason-@sub.SubOrderNumber">Reason</label>
                                                @{
                                                    var existingReason = string.Equals(Model.ReturnSubOrder, sub.SubOrderNumber, StringComparison.OrdinalIgnoreCase) ? Model.ReturnReason : string.Empty;
                                                }
                                                <textarea class="form-control" id="return-reason-@sub.SubOrderNumber" name="ReturnReason" rows="3">@existingReason</textarea>
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Submit return request</button>
                                        </form>
                                    </div>
                                }
                                else if (string.Equals(OrderStatuses.Normalize(sub.Status), OrderStatuses.Delivered, StringComparison.OrdinalIgnoreCase))
                                {
                                    <div class="text-muted small mb-3">Return window closed (@Model.ReturnWindowDays days after delivery).</div>
                                }
                                <div class="table-responsive">
                                    <table class="table align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col">Item</th>
                                                <th scope="col">Status</th>
                                                <th scope="col" class="text-end">Qty</th>
                                                <th scope="col" class="text-end">Unit</th>
                                                <th scope="col" class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in sub.Items)
                                            {
                                                var itemStatus = OrderStatuses.Normalize(item.Status);
                                                var badgeClass = "bg-secondary";
                                                if (itemStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-success";
                                                }
                                                else if (itemStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-primary";
                                                }
                                                else if (itemStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-info text-dark";
                                                }
                                                else if (itemStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-warning text-dark";
                                                }
                                                else if (itemStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    badgeClass = "bg-light text-dark border";
                                                }
                                                <tr>
                                                    <td>
                                                        <div class="fw-semibold">@item.Name</div>
                                                        @if (!string.IsNullOrWhiteSpace(item.Variant))
                                                        {
                                                            <div class="text-muted small">@item.Variant</div>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge @badgeClass">@itemStatus</span>
                                                    </td>
                                                    <td class="text-end">@item.Quantity</td>
                                                    <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                    <td class="text-end">@item.LineTotal.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    }
                    else if (order.Items != null && order.Items.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col">Item</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Seller</th>
                                        <th scope="col" class="text-end">Qty</th>
                                        <th scope="col" class="text-end">Unit</th>
                                        <th scope="col" class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in order.Items)
                                    {
                                        var itemStatus = OrderStatuses.Normalize(item.Status);
                                        var badgeClass = "bg-secondary";
                                        if (itemStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-success";
                                        }
                                        else if (itemStatus.Equals("Shipped", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-primary";
                                        }
                                        else if (itemStatus.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-info text-dark";
                                        }
                                        else if (itemStatus.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-warning text-dark";
                                        }
                                        else if (itemStatus.Equals("Refunded", StringComparison.OrdinalIgnoreCase))
                                        {
                                            badgeClass = "bg-light text-dark border";
                                        }
                                        <tr>
                                            <td>
                                                <div class="fw-semibold">@item.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(item.Variant))
                                                {
                                                    <div class="text-muted small">@item.Variant</div>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @badgeClass">@itemStatus</span>
                                            </td>
                                            <td>@item.SellerName</td>
                                            <td class="text-end">@item.Quantity</td>
                                            <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                            <td class="text-end">@item.LineTotal.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">Item details are not available.</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Delivery address</div>
                <div class="card-body">
                    @if (order.Address != null)
                    {
                        <div class="fw-semibold">@order.Address.Recipient</div>
                        <div>@order.Address.Line1</div>
                        @if (!string.IsNullOrWhiteSpace(order.Address.Line2))
                        {
                            <div>@order.Address.Line2</div>
                        }
                        <div>@order.Address.City @order.Address.State @order.Address.PostalCode</div>
                        <div>@order.Address.Country</div>
                        @if (!string.IsNullOrWhiteSpace(order.Address.Phone))
                        {
                            <div class="text-muted">Phone: @order.Address.Phone</div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">Address not available.</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Returns & support</div>
                <div class="card-body">
                    <div class="mb-2">You can request a return for delivered items within @Model.ReturnWindowDays days of delivery.</div>
                    @if (order.SubOrders != null && order.SubOrders.Any(s => s.Return != null))
                    {
                        <div class="small mb-0">Return requests in progress: @string.Join(", ", order.SubOrders.Where(s => s.Return != null).Select(s => $"{s.SubOrderNumber} - {s.Return!.Status}"))</div>
                    }
                    else
                    {
                        <div class="text-muted small mb-0">Use the \"Request a return\" option under an eligible sub-order above.</div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">Totals</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Items subtotal</span>
                        <span>@order.ItemsSubtotal.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span>@order.ShippingTotal.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 @(order.DiscountTotal > 0 ? string.Empty : "d-none")">
                        <span>Discount <span class="text-muted">@((order.PromoCode ?? string.Empty) == string.Empty ? string.Empty : $"({order.PromoCode})")</span></span>
                        <span>-@order.DiscountTotal.ToString("C")</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <strong>Total</strong>
                        <strong>@order.GrandTotal.ToString("C")</strong>
                    </div>
                    <div class="text-muted small mt-2">@order.TotalQuantity item(s)</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Payment</div>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="fw-semibold">Status</div>
                        @{
                            var paymentBadge = "bg-secondary";
                            if (order.PaymentStatus.Equals(PaymentStatuses.Paid, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-success";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Pending, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-warning text-dark";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Failed, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-danger";
                            }
                            else if (order.PaymentStatus.Equals(PaymentStatuses.Refunded, StringComparison.OrdinalIgnoreCase))
                            {
                                paymentBadge = "bg-info text-dark";
                            }
                        }
                        <span class="badge @paymentBadge">@order.PaymentStatus</span>
                        @if (!string.IsNullOrWhiteSpace(order.PaymentStatusMessage))
                        {
                            <div class="text-muted small mt-1">@order.PaymentStatusMessage</div>
                        }
                    </div>
                    <div class="mb-2">
                        <div class="fw-semibold">Method</div>
                        <div class="text-muted">@order.PaymentMethodLabel</div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(order.PaymentReference))
                    {
                        <div class="mb-2">
                            <div class="fw-semibold">Reference</div>
                            <div class="text-muted">@order.PaymentReference</div>
                        </div>
                    }
                    @if (order.PaymentRefundedAmount > 0)
                    {
                        <div class="mb-2 text-danger">
                            <div class="fw-semibold">Refunded</div>
                            <div class="text-muted">@order.PaymentRefundedAmount.ToString("C")</div>
                        </div>
                    }
                    <div class="mb-0">
                        <div class="fw-semibold">Order ID</div>
                        <div class="text-muted">@order.OrderNumber</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-outline-secondary" asp-page="/Buyer/Orders/Index">Back to orders</a>
    </div>
}
