@page "/Categories/{id:int?}"
@model SD.ProjectName.WebApp.Pages.Products.CategoryModel
@{
    ViewData["Title"] = Model.CurrentCategory?.Name ?? "Categories";
}

<div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div>
        <h1 class="mb-1">@ViewData["Title"]</h1>
        @if (Model.Breadcrumb.Any())
        {
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    @foreach (var crumb in Model.Breadcrumb)
                    {
                        var isLast = Model.Breadcrumb.Last() == crumb;
                        <li class="breadcrumb-item @(isLast ? "active" : string.Empty)" aria-current="@(isLast ? "page" : null)">
                            @if (isLast)
                            {
                                @crumb.Name
                            }
                            else
                            {
                                <a asp-page="/Products/Category" asp-route-id="@crumb.Id">@crumb.Name</a>
                            }
                        </li>
                    }
                </ol>
            </nav>
        }
    </div>
    <div class="text-end">
        @if (Model.IncludeSubcategories)
        {
            <a class="btn btn-outline-secondary" asp-page="/Products/Category" asp-route-id="@Model.CurrentCategory?.Id" asp-route-includeSubcategories="false" asp-route-sort="@Model.Sort">Show this category only</a>
        }
        else
        {
            <a class="btn btn-outline-secondary" asp-page="/Products/Category" asp-route-id="@Model.CurrentCategory?.Id" asp-route-includeSubcategories="true" asp-route-sort="@Model.Sort">Include subcategories</a>
        }
    </div>
</div>

@if (Model.Subcategories.Any())
{
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="h5">Subcategories</h2>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var child in Model.Subcategories)
                {
                    <a class="btn btn-light border" asp-page="/Products/Category" asp-route-id="@child.Id">
                        @child.Name
                        <span class="badge bg-secondary ms-2">@child.ProductCount</span>
                    </a>
                }
            </div>
        </div>
    </div>
}

<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Filters</h2>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary btn-sm" asp-page="/Products/Category" asp-route-id="@Model.CurrentCategory?.Id" asp-route-includeSubcategories="@Model.IncludeSubcategories">Clear all filters</a>
                <button type="submit" form="categoryFilters" class="btn btn-primary btn-sm">Apply filters</button>
            </div>
        </div>
        <form id="categoryFilters" method="get" asp-page="/Products/Category">
            <input type="hidden" name="includeSubcategories" value="@Model.IncludeSubcategories" />
            <input type="hidden" name="sort" value="@Model.Sort" />
            <input type="hidden" name="page" value="1" />
            <div class="row g-3">
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" for="categorySelect">Category</label>
                    <select id="categorySelect" name="id" class="form-select">
                        @foreach (var option in Model.CategoryOptions)
                        {
                            <option value="@option.Value" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" for="sellerSelect">Seller</label>
                    <select id="sellerSelect" name="sellerId" class="form-select">
                        <option value="">All sellers</option>
                        @foreach (var seller in Model.SellerOptions)
                        {
                            <option value="@seller.Value" selected="@(seller.Selected ? "selected" : null)">@seller.Text</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" for="conditionSelect">Condition</label>
                    <select id="conditionSelect" name="condition" class="form-select">
                        <option value="">Any condition</option>
                        @foreach (var condition in Model.ConditionOptions)
                        {
                            <option value="@condition" selected="@(string.Equals(Model.Condition, condition, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@condition</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Price range</label>
                    <div class="d-flex gap-2">
                        <input type="number" step="0.01" min="0" name="minPrice" value="@(Model.MinPrice?.ToString() ?? string.Empty)" class="form-control" placeholder="Min" />
                        <input type="number" step="0.01" min="0" name="maxPrice" value="@(Model.MaxPrice?.ToString() ?? string.Empty)" class="form-control" placeholder="Max" />
                    </div>
                </div>
            </div>
        </form>
        @if (Model.HasActiveFilters)
        {
            <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
                <span class="text-muted small">Active filters:</span>
                @foreach (var filter in Model.ActiveFilters)
                {
                    <span class="badge bg-primary">@filter</span>
                }
                <a class="btn btn-link btn-sm text-decoration-none" asp-page="/Products/Category" asp-route-id="@Model.CurrentCategory?.Id" asp-route-includeSubcategories="@Model.IncludeSubcategories">Clear</a>
            </div>
        }
    </div>
</div>

<div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="h5 mb-0">Products</h2>
    <div class="d-flex align-items-center gap-2">
        <small class="text-muted">@((Model.IncludeSubcategories ? "Including subcategories" : "This category only"))</small>
        <form method="get" class="d-flex align-items-center gap-2" asp-page="/Products/Category">
            <input type="hidden" name="includeSubcategories" value="@Model.IncludeSubcategories" />
            <input type="hidden" name="id" value="@Model.CurrentCategory?.Id" />
            <input type="hidden" name="condition" value="@Model.Condition" />
            <input type="hidden" name="sellerId" value="@Model.SellerId" />
            <input type="hidden" name="minPrice" value="@Model.MinPrice" />
            <input type="hidden" name="maxPrice" value="@Model.MaxPrice" />
            <input type="hidden" name="page" value="1" />
            <label class="form-label mb-0" for="categorySortSelect">Sort</label>
            <select id="categorySortSelect" name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
                @foreach (var option in Model.SortOptions)
                {
                    <option value="@option.Value" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
                }
            </select>
            <noscript>
                <button type="submit" class="btn btn-sm btn-primary">Apply</button>
            </noscript>
        </form>
    </div>
</div>

@if (Model.Products.Any())
{
    var start = Model.TotalResults == 0 ? 0 : ((Model.PageNumber - 1) * Model.PageSize) + 1;
    var end = Math.Min(Model.PageNumber * Model.PageSize, Model.TotalResults);
    <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="text-muted small">
            Showing @start-@end of @Model.TotalResults product@(Model.TotalResults == 1 ? string.Empty : "s")
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Price</th>
                    <th>Category</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model.Products)
                {
                    var resultReturnUrl = Url.Page("/Products/Category", new
                    {
                        id = Model.CurrentCategory?.Id,
                        includeSubcategories = Model.IncludeSubcategories,
                        sellerId = Model.SellerId,
                        condition = Model.Condition,
                        minPrice = Model.MinPrice,
                        maxPrice = Model.MaxPrice,
                        sort = Model.Sort,
                        page = Model.PageNumber
                    });
                    <tr>
                        <td>
                            <a asp-page="/Products/Details" asp-route-id="@product.Id" asp-route-returnUrl="@resultReturnUrl">@product.Title</a>
                        </td>
                        <td>@product.Price.ToString("C")</td>
                        <td>@product.Category</td>
                        <td>@product.Stock</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="d-flex align-items-center justify-content-between mt-3">
        <div class="text-muted small">
            Showing @((Model.TotalResults == 0 ? 0 : ((Model.PageNumber - 1) * Model.PageSize) + 1))-@Math.Min(Model.PageNumber * Model.PageSize, Model.TotalResults) of @Model.TotalResults product@(Model.TotalResults == 1 ? string.Empty : "s")
        </div>
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Category product pages">
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.PageNumber == 1 ? "disabled" : string.Empty)">
                        <a class="page-link"
                           asp-page="/Products/Category"
                           asp-route-page="@(Model.PageNumber - 1)"
                           asp-route-id="@Model.CurrentCategory?.Id"
                           asp-route-includeSubcategories="@Model.IncludeSubcategories"
                           asp-route-condition="@Model.Condition"
                           asp-route-sellerId="@Model.SellerId"
                           asp-route-minPrice="@Model.MinPrice"
                           asp-route-maxPrice="@Model.MaxPrice"
                           asp-route-sort="@Model.Sort">Previous</a>
                    </li>
                    @for (var pageNumber = 1; pageNumber <= Model.TotalPages; pageNumber++)
                    {
                        <li class="page-item @(pageNumber == Model.PageNumber ? "active" : string.Empty)">
                            <a class="page-link"
                               asp-page="/Products/Category"
                               asp-route-page="@pageNumber"
                               asp-route-id="@Model.CurrentCategory?.Id"
                               asp-route-includeSubcategories="@Model.IncludeSubcategories"
                               asp-route-condition="@Model.Condition"
                               asp-route-sellerId="@Model.SellerId"
                               asp-route-minPrice="@Model.MinPrice"
                               asp-route-maxPrice="@Model.MaxPrice"
                               asp-route-sort="@Model.Sort">@pageNumber</a>
                        </li>
                    }
                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link"
                           asp-page="/Products/Category"
                           asp-route-page="@(Model.PageNumber + 1)"
                           asp-route-id="@Model.CurrentCategory?.Id"
                           asp-route-includeSubcategories="@Model.IncludeSubcategories"
                           asp-route-condition="@Model.Condition"
                           asp-route-sellerId="@Model.SellerId"
                           asp-route-minPrice="@Model.MinPrice"
                           asp-route-maxPrice="@Model.MaxPrice"
                           asp-route-sort="@Model.Sort">Next</a>
                    </li>
                </ul>
            </nav>
        }
        else
        {
            <span class="text-muted small">All results are displayed.</span>
        }
    </div>
}
else
{
    <div class="alert alert-info">
        <p class="mb-1">@Model.StatusMessage</p>
        @if (Model.HasActiveFilters)
        {
            <p class="mb-0">Active filters are highlighted above. <a class="link-primary" asp-page="/Products/Category" asp-route-id="@Model.CurrentCategory?.Id" asp-route-includeSubcategories="@Model.IncludeSubcategories">Clear filters</a> to see all products.</p>
        }
        else if (Model.Subcategories.Any())
        {
            <p class="mb-0">Try a subcategory above or <a asp-page="/Products/List">browse all products</a>.</p>
        }
        else
        {
            <p class="mb-0">Try another category or use search when available.</p>
        }
    </div>
}
