@page "/Products/Details/{id:int}"
@using System.Text.Json
@using System.Text.Json.Serialization
@model SD.ProjectName.WebApp.Pages.Products.DetailsModel
@{
    ViewData["Title"] = Model.Product?.Title ?? "Product unavailable";
}

@if (Model.Product == null)
{
    <div class="alert alert-warning" role="alert">
        @Model.StatusMessage ?? "This product is unavailable."
    </div>
}
else
{
    <h1>@Model.Product.Title</h1>
    @if (!string.IsNullOrWhiteSpace(Model.Product.MainImageUrl))
    {
        <div class="mb-3">
            <img id="main-image" src="@Model.Product.MainImageUrl" alt="Main image for @Model.Product.Title" class="img-fluid rounded" />
        </div>
    }
    @if (Model.Product.HasVariants && Model.Product.Variants.Any())
    {
        var variantJson = JsonSerializer.Serialize(Model.Product.Variants, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase });
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Choose options</h5>
                <div id="variant-selectors" class="d-flex flex-wrap gap-3"></div>
                <div id="variant-status" class="mt-2 text-danger d-none">This variant is unavailable.</div>
            </div>
        </div>
        <script>
            (function () {
                const variants = @Html.Raw(variantJson);
                if (!variants.length) return;

                const selectors = document.getElementById('variant-selectors');
                const mainImage = document.getElementById('main-image');
                const priceEl = document.getElementById('variant-price');
                const stockEl = document.getElementById('variant-stock');
                const statusEl = document.getElementById('variant-status');
                const addBtn = document.getElementById('add-to-cart');

                const attributes = Array.from(new Set(variants.flatMap(v => Object.keys(v.attributes || {}))));
                const attributeValues = {};
                attributes.forEach(name => {
                    attributeValues[name] = Array.from(new Set(variants.map(v => v.attributes?.[name]).filter(Boolean)));
                });

                const state = {};
                attributes.forEach(name => state[name] = attributeValues[name][0]);

                function buildSelectors() {
                    selectors.innerHTML = '';
                    attributes.forEach(name => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'form-group';
                        const label = document.createElement('label');
                        label.textContent = name;
                        const select = document.createElement('select');
                        select.className = 'form-select';
                        attributeValues[name].forEach(val => {
                            const opt = document.createElement('option');
                            opt.value = val;
                            opt.textContent = val;
                            if (state[name] === val) opt.selected = true;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', (e) => {
                            state[name] = e.target.value;
                            updateVariant();
                        });
                        wrapper.appendChild(label);
                        wrapper.appendChild(select);
                        selectors.appendChild(wrapper);
                    });
                }

                function findVariant() {
                    return variants.find(v => attributes.every(a => v.attributes?.[a] === state[a]));
                }

                function updateVariant() {
                    const variant = findVariant();
                    if (!variant) {
                        statusEl.classList.remove('d-none');
                        priceEl.textContent = '—';
                        stockEl.textContent = '0';
                        addBtn?.setAttribute('disabled', 'disabled');
                        return;
                    }

                    statusEl.classList.toggle('d-none', variant.stock > 0);
                    priceEl.textContent = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(variant.price);
                    stockEl.textContent = variant.stock;
                    if (addBtn) {
                        if (variant.stock > 0) {
                            addBtn.removeAttribute('disabled');
                        } else {
                            addBtn.setAttribute('disabled', 'disabled');
                        }
                    }

                    if (variant.imageUrl && mainImage) {
                        mainImage.src = variant.imageUrl;
                    }
                }

                buildSelectors();
                updateVariant();
            })();
        </script>
    }
    <dl class="row">
        <dt class="col-sm-2">Price</dt>
        <dd class="col-sm-10"><span id="variant-price">@Model.Product.Price.ToString("C")</span></dd>
        <dt class="col-sm-2">Category</dt>
        <dd class="col-sm-10">@Model.Product.Category</dd>
        <dt class="col-sm-2">Stock</dt>
        <dd class="col-sm-10"><span id="variant-stock">@Model.Product.Stock</span></dd>
        @if (!string.IsNullOrWhiteSpace(Model.Product.Description))
        {
            <dt class="col-sm-2">Description</dt>
            <dd class="col-sm-10">@Model.Product.Description</dd>
        }
        @if (!string.IsNullOrWhiteSpace(Model.Product.ShippingMethods))
        {
            <dt class="col-sm-2">Shipping</dt>
            <dd class="col-sm-10">@Model.Product.ShippingMethods</dd>
        }
        @if (Model.Product.WeightKg.HasValue || Model.Product.LengthCm.HasValue || Model.Product.WidthCm.HasValue || Model.Product.HeightCm.HasValue)
        {
            <dt class="col-sm-2">Package</dt>
            <dd class="col-sm-10">
                <div>Weight: @(Model.Product.WeightKg?.ToString("0.###") ?? "n/a") kg</div>
                <div>Dimensions: @(Model.Product.LengthCm?.ToString("0.###") ?? "n/a") x @(Model.Product.WidthCm?.ToString("0.###") ?? "n/a") x @(Model.Product.HeightCm?.ToString("0.###") ?? "n/a") cm</div>
            </dd>
        }
        @if (!string.IsNullOrWhiteSpace(Model.Product.GalleryImageUrls))
        {
            var galleryImages = Model.Product.GalleryImageUrls
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
            if (galleryImages.Any())
            {
                <dt class="col-sm-2">Gallery</dt>
                <dd class="col-sm-10 d-flex flex-wrap gap-2">
                    @foreach (var image in galleryImages)
                    {
                        <img src="@image" alt="Gallery image for @Model.Product.Title" class="img-thumbnail" style="max-width: 120px;" />
                    }
                </dd>
            }
        }
    </dl>
    <div class="mt-3">
        <button id="add-to-cart" type="button" class="btn btn-primary" @(Model.Product.Stock > 0 ? "" : "disabled")>Add to cart</button>
        @if (Model.Product.HasVariants && Model.Product.Variants.Any())
        {
            <span class="text-muted ms-2">Select a variant to see availability.</span>
        }
    </div>
}
