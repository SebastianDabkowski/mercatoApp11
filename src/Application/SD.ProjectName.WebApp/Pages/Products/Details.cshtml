@page "/Products/Details/{id:int}"
@using System.Text.Json
@using System.Text.Json.Serialization
@using SD.ProjectName.WebApp.Identity
@model SD.ProjectName.WebApp.Pages.Products.DetailsModel
@{
    ViewData["Title"] = Model.Product?.Title ?? "Product unavailable";
}

@if (Model.Product == null)
{
    <div class="alert alert-warning" role="alert">
        @Model.StatusMessage ?? "This product is unavailable."
    </div>
}
else
{
    @if (!string.IsNullOrWhiteSpace(Model.ReturnUrl))
    {
        <a class="btn btn-link px-0" href="@Model.ReturnUrl">Back to results</a>
    }
    <h1>@Model.Product.Title</h1>
    @if (!string.IsNullOrWhiteSpace(Model.Product.MainImageUrl))
    {
        <div class="mb-3">
            <img id="main-image" src="@Model.Product.MainImageUrl" alt="Main image for @Model.Product.Title" class="img-fluid rounded" />
        </div>
    }
    @if (Model.Product.HasVariants && Model.Product.Variants.Any())
    {
        var variantJson = JsonSerializer.Serialize(Model.Product.Variants, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase });
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Choose options</h5>
                <div id="variant-selectors" class="d-flex flex-wrap gap-3"></div>
                <div id="variant-status" class="mt-2 text-danger d-none">This variant is unavailable.</div>
            </div>
        </div>
        <script>
            (function () {
                const variants = @Html.Raw(variantJson);
                if (!variants.length) return;

                const selectors = document.getElementById('variant-selectors');
                const mainImage = document.getElementById('main-image');
                const priceEl = document.getElementById('variant-price');
                const stockEl = document.getElementById('variant-stock');
                const statusEl = document.getElementById('variant-status');
                const addBtn = document.getElementById('add-to-cart');

                const attributes = Array.from(new Set(variants.flatMap(v => Object.keys(v.attributes || {}))));
                const attributeValues = {};
                attributes.forEach(name => {
                    attributeValues[name] = Array.from(new Set(variants.map(v => v.attributes?.[name]).filter(Boolean)));
                });

                const state = {};
                attributes.forEach(name => state[name] = attributeValues[name][0]);

                function buildSelectors() {
                    selectors.innerHTML = '';
                    attributes.forEach(name => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'form-group';
                        const label = document.createElement('label');
                        label.textContent = name;
                        const select = document.createElement('select');
                        select.className = 'form-select';
                        attributeValues[name].forEach(val => {
                            const opt = document.createElement('option');
                            opt.value = val;
                            opt.textContent = val;
                            if (state[name] === val) opt.selected = true;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', (e) => {
                            state[name] = e.target.value;
                            updateVariant();
                        });
                        wrapper.appendChild(label);
                        wrapper.appendChild(select);
                        selectors.appendChild(wrapper);
                    });
                }

                function findVariant() {
                    return variants.find(v => attributes.every(a => v.attributes?.[a] === state[a]));
                }

                function updateVariant() {
                    const variant = findVariant();
                    if (!variant) {
                        statusEl.classList.remove('d-none');
                        priceEl.textContent = '—';
                        stockEl.textContent = '0';
                        addBtn?.setAttribute('disabled', 'disabled');
                        if (addBtn) {
                            addBtn.dataset.variantSelection = '';
                            addBtn.dataset.variantAvailable = 'false';
                        }
                        return;
                    }

                    statusEl.classList.toggle('d-none', variant.stock > 0);
                    priceEl.textContent = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(variant.price);
                    stockEl.textContent = variant.stock;
                    if (addBtn) {
                        addBtn.dataset.variantSelection = JSON.stringify(state);
                        addBtn.dataset.variantAvailable = variant.stock > 0 ? 'true' : 'false';
                        if (variant.stock > 0) {
                            addBtn.removeAttribute('disabled');
                        } else {
                            addBtn.setAttribute('disabled', 'disabled');
                        }
                    }

                    if (variant.imageUrl && mainImage) {
                        mainImage.src = variant.imageUrl;
                    }
                }

                buildSelectors();
                updateVariant();
            })();
        </script>
    }
    <dl class="row">
        <dt class="col-sm-2">Price</dt>
        <dd class="col-sm-10"><span id="variant-price">@Model.Product.Price.ToString("C")</span></dd>
        <dt class="col-sm-2">Category</dt>
        <dd class="col-sm-10">
            @if (Model.Product.CategoryId.HasValue)
            {
                <a asp-page="/Products/Category" asp-route-id="@Model.Product.CategoryId">@Model.Product.Category</a>
            }
            else
            {
                @Model.Product.Category
            }
        </dd>
        @if (Model.HasSellerLink)
        {
            <dt class="col-sm-2">Seller</dt>
            <dd class="col-sm-10">
                <a asp-page="/Store/Details" asp-route-storeSlug="@Model.SellerSlug">@Model.SellerDisplayName</a>
            </dd>
        }
        <dt class="col-sm-2">Stock</dt>
        <dd class="col-sm-10"><span id="variant-stock">@Model.Product.Stock</span></dd>
        @if (!string.IsNullOrWhiteSpace(Model.Product.Description))
        {
            <dt class="col-sm-2">Description</dt>
            <dd class="col-sm-10">@Model.Product.Description</dd>
        }
        @if (!string.IsNullOrWhiteSpace(Model.Product.ShippingMethods))
        {
            <dt class="col-sm-2">Shipping</dt>
            <dd class="col-sm-10">@Model.Product.ShippingMethods</dd>
        }
        @if (Model.Product.WeightKg.HasValue || Model.Product.LengthCm.HasValue || Model.Product.WidthCm.HasValue || Model.Product.HeightCm.HasValue)
        {
            <dt class="col-sm-2">Package</dt>
            <dd class="col-sm-10">
                <div>Weight: @(Model.Product.WeightKg?.ToString("0.###") ?? "n/a") kg</div>
                <div>Dimensions: @(Model.Product.LengthCm?.ToString("0.###") ?? "n/a") x @(Model.Product.WidthCm?.ToString("0.###") ?? "n/a") x @(Model.Product.HeightCm?.ToString("0.###") ?? "n/a") cm</div>
            </dd>
        }
        @if (!string.IsNullOrWhiteSpace(Model.Product.GalleryImageUrls))
        {
            var galleryImages = Model.Product.GalleryImageUrls
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
            if (galleryImages.Any())
            {
                <dt class="col-sm-2">Gallery</dt>
                <dd class="col-sm-10 d-flex flex-wrap gap-2">
                    @foreach (var image in galleryImages)
                    {
                        <img src="@image" alt="Gallery image for @Model.Product.Title" class="img-thumbnail" style="max-width: 120px;" />
                    }
                </dd>
            }
        }
    </dl>
    <div class="mt-3">
        <button id="add-to-cart"
                type="button"
                class="btn btn-primary"
                data-product-id="@Model.Product.Id"
                data-has-variants="@(Model.Product.HasVariants.ToString().ToLowerInvariant())"
                @(Model.Product.Stock > 0 ? "" : "disabled")>Add to cart</button>
        <div id="cart-status" class="mt-2 text-success d-none"></div>
        @if (Model.Product.HasVariants && Model.Product.Variants.Any())
        {
            <span class="text-muted ms-2">Select a variant to see availability.</span>
        }
    </div>
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Questions about this product</span>
            <span class="text-muted small">Buyer to seller</span>
        </div>
        <div class="card-body">
            <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
            @if (Model.Questions.Any())
            {
                <div class="mb-3">
                    @foreach (var question in Model.Questions)
                    {
                        <div class="border-bottom pb-2 mb-2">
                            <div class="fw-semibold">@question.BuyerName</div>
                            <div class="text-muted small">@question.CreatedOn.ToLocalTime().ToString("g")</div>
                            <div class="mt-1">@question.Question</div>
                            @if (!string.IsNullOrWhiteSpace(question.Answer))
                            {
                                <div class="mt-2 p-2 bg-light rounded">
                                    <div class="fw-semibold small">Seller reply</div>
                                    <div>@question.Answer</div>
                                </div>
                            }
                            else
                            {
                                <div class="text-muted small mt-1">Awaiting seller response.</div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-light border">No questions yet. Be the first to ask.</div>
            }

            @if (User?.Identity?.IsAuthenticated == true && User.IsInRole(AccountTypes.Buyer))
            {
                <form method="post" asp-page-handler="Question" asp-route-id="@Model.Product!.Id" asp-route-returnUrl="@Model.ReturnUrl">
                    <div class="mb-2">
                        <label class="form-label" asp-for="QuestionContent">Ask the seller</label>
                        <textarea class="form-control" asp-for="QuestionContent" rows="3" maxlength="2000" placeholder="Ask about sizing, shipping, or other details."></textarea>
                        <span class="text-danger small" asp-validation-for="QuestionContent"></span>
                    </div>
                    <button type="submit" class="btn btn-sm btn-outline-primary">Send question</button>
                </form>
            }
            else
            {
                <div class="text-muted small">Sign in as a buyer to ask a question.</div>
            }
        </div>
    </div>
    @if (Model.Reviews.Any())
    {
        <div class="card mt-4">
            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span>Customer reviews</span>
                    @if (Model.AverageRating.HasValue)
                    {
                        <span class="badge bg-success">Average @Model.AverageRating.Value.ToString("0.0")/5</span>
                    }
                </div>
                <form method="get" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="id" value="@Model.Product!.Id" />
                    <input type="hidden" name="page" value="1" />
                    @if (!string.IsNullOrWhiteSpace(Model.ReturnUrl))
                    {
                        <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
                    }
                    <label class="form-label mb-0 small" for="review-sort">Sort</label>
                    <select id="review-sort" name="sort" class="form-select form-select-sm" onchange="this.form.submit();">
                        <option value="newest" selected="@(Model.SortOption == "newest" ? "selected" : null)">Newest</option>
                        <option value="highest" selected="@(Model.SortOption == "highest" ? "selected" : null)">Highest rating</option>
                        <option value="lowest" selected="@(Model.SortOption == "lowest" ? "selected" : null)">Lowest rating</option>
                    </select>
                </form>
            </div>
            <div class="card-body">
                @foreach (var review in Model.Reviews)
                {
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="fw-semibold">@review.BuyerName</div>
                            <div class="text-muted small">@review.CreatedOn.ToLocalTime().ToString("g")</div>
                        </div>
                        <div class="mb-2">Rating: @review.Rating/5</div>
                        <div>@review.Comment</div>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="d-flex flex-wrap align-items-center gap-2 mt-2 review-report" data-review-id="@review.Id">
                                <label class="small mb-0" for="report-reason-@review.Id">Report</label>
                                <select id="report-reason-@review.Id" class="form-select form-select-sm review-report-reason" data-review-id="@review.Id">
                                    <option value="">Select reason</option>
                                    @foreach (var reason in Model.ReportReasons)
                                    {
                                        <option value="@reason">@reason</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-danger report-review-btn" data-review-id="@review.Id">Report</button>
                                <div class="small text-muted d-none review-report-status" data-review-id="@review.Id"></div>
                            </div>
                        }
                        else
                        {
                            <div class="small text-muted mt-2">Sign in to report this review.</div>
                        }
                    </div>
                }
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Review pages" class="mt-3">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : string.Empty)">
                                <a class="page-link" href="@Url.Page("/Products/Details", new { id = Model.Product!.Id, page = Model.PageNumber - 1, sort = Model.SortOption, returnUrl = Model.ReturnUrl })">Previous</a>
                            </li>
                            @for (var pageNumber = 1; pageNumber <= Model.TotalPages; pageNumber++)
                            {
                                <li class="page-item @(pageNumber == Model.PageNumber ? "active" : string.Empty)">
                                    <a class="page-link" href="@Url.Page("/Products/Details", new { id = Model.Product!.Id, page = pageNumber, sort = Model.SortOption, returnUrl = Model.ReturnUrl })">@pageNumber</a>
                                </li>
                            }
                            <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : string.Empty)">
                                <a class="page-link" href="@Url.Page("/Products/Details", new { id = Model.Product!.Id, page = Model.PageNumber + 1, sort = Model.SortOption, returnUrl = Model.ReturnUrl })">Next</a>
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-light border mt-4">No reviews yet. Buyers can leave feedback after their orders are delivered.</div>
    }
}

@if (Model.RecentlyViewedProducts.Any())
{
    <div class="mt-5">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Recently viewed</h2>
            <span class="text-muted small">Stored on this device</span>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
            @foreach (var product in Model.RecentlyViewedProducts)
            {
                var description = string.IsNullOrWhiteSpace(product.Description)
                    ? "No description provided."
                    : (product.Description.Length > 90 ? $"{product.Description[..90]}..." : product.Description);
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="ratio ratio-4x3 bg-light border-bottom">
                            @if (!string.IsNullOrWhiteSpace(product.MainImageUrl))
                            {
                                <img src="@product.MainImageUrl"
                                     alt="Thumbnail for @product.Title"
                                     class="w-100 h-100 rounded-top"
                                     style="object-fit: cover; object-position: center;" />
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center text-muted small w-100 h-100">
                                    No image
                                </div>
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-start justify-content-between mb-2">
                                <h5 class="card-title mb-0 me-2">@product.Title</h5>
                                <span class="fw-semibold text-primary">@product.Price.ToString("C")</span>
                            </div>
                            <div class="text-muted small mb-2">@product.Category</div>
                            <p class="card-text flex-grow-1">@description</p>
                            <div class="d-flex align-items-center justify-content-between pt-2">
                                <span class="text-muted small">Stock: @product.Stock</span>
                                <a class="btn btn-sm btn-outline-primary" asp-page="/Products/Details" asp-route-id="@product.Id">View</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script>
        (() => {
            const button = document.getElementById('add-to-cart');
            const status = document.getElementById('cart-status');
            if (!button) return;

            const productId = parseInt(button.dataset.productId || '0', 10);
            if (!productId) return;

            if (button.dataset.hasVariants !== 'true' && !button.dataset.variantSelection) {
                button.dataset.variantSelection = "{}";
            }

            const showStatus = (text, success) => {
                if (!status) return;
                status.textContent = text;
                status.classList.toggle('text-success', !!success);
                status.classList.toggle('text-danger', !success);
                status.classList.remove('d-none');
            };

            const readVariant = () => {
                const raw = button.dataset.variantSelection;
                if (!raw) {
                    return undefined;
                }
                try {
                    return JSON.parse(raw);
                } catch {
                    return undefined;
                }
            };

            button.addEventListener('click', () => {
                const payload = {
                    productId,
                    quantity: 1,
                    variantAttributes: readVariant()
                };

                button.disabled = true;
                fetch('/Api/Cart?handler=Add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json().catch(() => ({})).then(data => ({ ok: response.ok, data })))
                    .then(result => {
                        if (result.ok && result.data?.success) {
                            showStatus(result.data.message || 'Added to cart.', true);
                            return;
                        }
                        showStatus(result.data?.message || 'Could not add to cart.', false);
                    })
                    .catch(() => showStatus('Could not add to cart.', false))
                    .finally(() => {
                        if (button.dataset.variantAvailable !== 'false') {
                            button.disabled = false;
                        }
                    });
            });
        })();

        (() => {
            const reportBlocks = document.querySelectorAll('.review-report');
            if (!reportBlocks.length) return;

            reportBlocks.forEach(block => {
                const button = block.querySelector('.report-review-btn');
                const reason = block.querySelector('.review-report-reason');
                const status = block.querySelector('.review-report-status');

                if (!button || !reason) {
                    return;
                }

                const setStatus = (text, success) => {
                    if (!status) return;
                    status.textContent = text;
                    status.classList.toggle('text-danger', !success);
                    status.classList.toggle('text-success', !!success);
                    status.classList.remove('d-none');
                };

                button.addEventListener('click', () => {
                    const reviewId = parseInt(button.dataset.reviewId || '0', 10);
                    const selectedReason = reason.value;
                    if (!reviewId) {
                        return;
                    }

                    if (!selectedReason) {
                        setStatus('Select a reason to report.', false);
                        return;
                    }

                    button.disabled = true;

                    fetch('/Api/Reviews?handler=Report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reviewId, reason: selectedReason })
                    })
                        .then(response => response.json().catch(() => ({})).then(data => ({ ok: response.ok, data })))
                        .then(result => {
                            const message = result.data?.message || (result.ok ? 'Report submitted.' : 'Could not report this review.');
                            setStatus(message, result.ok);
                            if (result.ok) {
                                button.setAttribute('disabled', 'disabled');
                                reason.setAttribute('disabled', 'disabled');
                            } else {
                                button.disabled = false;
                            }
                        })
                        .catch(() => {
                            setStatus('Could not report this review.', false);
                            button.disabled = false;
                        });
                });
            });
        })();
    </script>
}
