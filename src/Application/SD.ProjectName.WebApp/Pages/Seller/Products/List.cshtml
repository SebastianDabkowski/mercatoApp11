@page "/Seller/Products"
@using SD.ProjectName.Modules.Products.Domain
@model SD.ProjectName.WebApp.Pages.Seller.Products.ListModel
@{
    ViewData["Title"] = "My products";
}

<h1>My products</h1>

@if (TempData["StatusMessage"] is string statusMessage)
{
    <div class="alert alert-success">@statusMessage</div>
}
@if (TempData["ErrorMessage"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<form method="get" class="row g-2 mb-3">
    <div class="col-sm-4">
        <label class="form-label" for="searchInput">Search</label>
        <input id="searchInput" name="Search" value="@Model.Search" class="form-control" placeholder="Title or SKU" />
    </div>
    <div class="col-sm-3">
        <label class="form-label" for="workflowFilter">Status</label>
        <select id="workflowFilter" name="WorkflowStateFilter" class="form-select">
            <option value="" selected="@(string.IsNullOrEmpty(Model.WorkflowStateFilter) ? "selected" : null)">All statuses</option>
            <option value="@ProductWorkflowStates.Pending" selected="@(Model.WorkflowStateFilter == ProductWorkflowStates.Pending ? "selected" : null)">Pending review</option>
            <option value="@ProductWorkflowStates.Active" selected="@(Model.WorkflowStateFilter == ProductWorkflowStates.Active ? "selected" : null)">Approved</option>
            <option value="@ProductWorkflowStates.Rejected" selected="@(Model.WorkflowStateFilter == ProductWorkflowStates.Rejected ? "selected" : null)">Rejected</option>
            <option value="@ProductWorkflowStates.Draft" selected="@(Model.WorkflowStateFilter == ProductWorkflowStates.Draft ? "selected" : null)">Draft</option>
            <option value="@ProductWorkflowStates.Suspended" selected="@(Model.WorkflowStateFilter == ProductWorkflowStates.Suspended ? "selected" : null)">Suspended</option>
        </select>
    </div>
    <div class="col-sm-2 align-self-end">
        <button type="submit" class="btn btn-primary">Apply</button>
    </div>
    <div class="col-sm-2 align-self-end">
        <a class="btn btn-outline-secondary" asp-page="/Seller/Products/List">Clear</a>
    </div>
</form>

<p>
    <a class="btn btn-primary" asp-page="Add">Add product</a>
    <a class="btn btn-outline-primary ms-2" asp-page="Import">Import catalog</a>
    <a class="btn btn-outline-secondary ms-2" asp-page="ExportHistory">Export history</a>
    @if (Model.Products.Any())
    {
        <form id="bulkForm" method="get" asp-page="BulkUpdate" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary ms-2">Bulk update price & stock</button>
        </form>
    }
</p>

<div class="card mb-3">
    <div class="card-body">
        <form method="post" asp-page-handler="Export" class="row g-2 align-items-end">
            <input type="hidden" asp-for="Search" />
            <input type="hidden" asp-for="WorkflowStateFilter" />
            <div class="col-sm-3">
                <label class="form-label" asp-for="ExportFormat">Export format</label>
                <select asp-for="ExportFormat" class="form-select">
                    <option value="csv">CSV</option>
                    <option value="xls">XLS</option>
                </select>
            </div>
            <div class="col-sm-5 form-check mt-sm-4">
                <input class="form-check-input" asp-for="ExportFilteredOnly" id="exportFiltered" />
                <label class="form-check-label" for="exportFiltered">Export only filtered results</label>
            </div>
            <div class="col-sm-3">
                <button type="submit" class="btn btn-success mt-sm-4">Export catalog</button>
            </div>
        </form>
    </div>
</div>

@if (Model.Products.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Select</th>
                <th>Title</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Category</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in Model.Products)
            {
                <tr>
                    <td>
                        <input type="checkbox" form="bulkForm" name="selectedIds" value="@product.Id" aria-label="Select @product.Title" />
                    </td>
                    <td>@product.Title</td>
                    <td>@product.Price.ToString("C")</td>
                    <td>@product.Stock</td>
                    <td>@product.Category</td>
                    <td>
                        @{
                            var moderationClass = product.ModerationStatus == ProductModerationStatuses.Approved
                                ? "text-bg-success"
                                : product.ModerationStatus == ProductModerationStatuses.Rejected
                                    ? "text-bg-danger"
                                    : "text-bg-warning text-dark";
                        }
                        <div class="badge @moderationClass text-capitalize">@product.ModerationStatus</div>
                        <div class="text-muted small text-capitalize">Workflow: @product.WorkflowState</div>
                        @if (product.ModerationStatus == ProductModerationStatuses.Rejected && !string.IsNullOrWhiteSpace(product.ModerationNote))
                        {
                            <div class="small mt-1">Reason: @product.ModerationNote</div>
                        }
                    </td>
                    <td>
                        <a class="btn btn-sm btn-outline-primary" asp-page="Edit" asp-route-id="@product.Id">Edit</a>
                        @if (product.WorkflowState == ProductWorkflowStates.Active)
                        {
                            <form method="post" asp-page-handler="Suspend" asp-route-id="@product.Id" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Suspend this product?')">Suspend</button>
                            </form>
                        }
                        else if (product.WorkflowState == ProductWorkflowStates.Pending)
                        {
                            <span class="badge text-bg-secondary">Awaiting review</span>
                        }
                        else
                        {
                            <form method="post" asp-page-handler="Activate" asp-route-id="@product.Id" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Submit this product for moderation?')">Submit for review</button>
                            </form>
                        }
                        <form method="post" asp-page-handler="Delete" asp-route-id="@product.Id" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this product?')">Delete</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No products yet. Create your first product to start building your catalog.</p>
}
