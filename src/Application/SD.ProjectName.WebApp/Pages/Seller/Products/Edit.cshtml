@page "/Seller/Products/Edit/{id:int}"
@model SD.ProjectName.WebApp.Pages.Seller.Products.EditModel
@using System.Text.Json
@using System.Collections.Generic
@{
    ViewData["Title"] = "Edit product";
}

<h1>Edit product</h1>

<div class="row">
    <div class="col-md-6">
        <form method="post" enctype="multipart/form-data">
            <input asp-for="Input.Id" type="hidden" />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Input.Title"></label>
                <input asp-for="Input.Title" class="form-control" />
                <span asp-validation-for="Input.Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Input.MerchantSku"></label>
                <input asp-for="Input.MerchantSku" class="form-control" />
                <span asp-validation-for="Input.MerchantSku" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Input.Price"></label>
                <input asp-for="Input.Price" class="form-control" />
                <span asp-validation-for="Input.Price" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Input.Stock"></label>
                <input asp-for="Input.Stock" class="form-control" />
                <span asp-validation-for="Input.Stock" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Input.CategoryId"></label>
                <select asp-for="Input.CategoryId" class="form-control" asp-items="Model.CategoryOptions">
                    <option value="">Select a category</option>
                </select>
                <span asp-validation-for="Input.CategoryId" class="text-danger"></span>
            </div>
            <div id="category-attributes" class="mb-3"></div>
            <div class="form-group">
                <label asp-for="Input.Description"></label>
                <textarea asp-for="Input.Description" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Input.Description" class="text-danger"></span>
            </div>
            <div class="form-check mb-2">
                <input asp-for="Input.HasVariants" class="form-check-input" />
                <label asp-for="Input.HasVariants" class="form-check-label">This product has variants</label>
            </div>
            <div class="form-group">
                <label asp-for="Input.VariantJson"></label>
                <textarea asp-for="Input.VariantJson" class="form-control" rows="4" placeholder='[{"sku":"SKU-S","price":10,"stock":5,"attributes":{"Size":"S"},"imageUrl":"https://..." }]'></textarea>
                <small class="form-text text-muted">Provide variant combinations as JSON with price, stock and attribute values. Leave blank if no variants.</small>
                <span asp-validation-for="Input.VariantJson" class="text-danger"></span>
            </div>
            <input asp-for="Input.MainImageUrl" type="hidden" />
            <input asp-for="Input.GalleryImageUrls" type="hidden" />
            <div class="form-group">
                <label asp-for="Input.ImageFiles"></label>
                <input asp-for="Input.ImageFiles" type="file" class="form-control" multiple accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp" />
                <small class="form-text text-muted">JPG, PNG or WebP up to 5 MB each. Images are optimized and thumbnails generated automatically.</small>
                <span asp-validation-for="Input.ImageFiles" class="text-danger"></span>
            </div>
            @if (Model.ImagePreviews.Any())
            {
                var selectedMain = Model.Input.SelectedMainImage ?? Model.Input.MainImageUrl;
                <div class="form-group">
                    <label>Main image</label>
                    <div class="d-flex flex-wrap align-items-start">
                        @foreach (var image in Model.ImagePreviews)
                        {
                            var isSelected = (!string.IsNullOrEmpty(selectedMain) && string.Equals(selectedMain, image, StringComparison.OrdinalIgnoreCase))
                                             || (string.IsNullOrEmpty(selectedMain) && image == Model.ImagePreviews.First());
                            <div class="me-3 mb-3 text-center">
                                <input type="radio" name="Input.SelectedMainImage" value="@image" @(isSelected ? "checked" : null) class="form-check-input" />
                                <div class="mt-2">
                                    <img src="@image" alt="Product image option" class="img-thumbnail" style="max-width: 140px;" />
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label asp-for="Input.WeightKg"></label>
                    <input asp-for="Input.WeightKg" class="form-control" />
                    <span asp-validation-for="Input.WeightKg" class="text-danger"></span>
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="Input.LengthCm"></label>
                    <input asp-for="Input.LengthCm" class="form-control" />
                    <span asp-validation-for="Input.LengthCm" class="text-danger"></span>
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="Input.WidthCm"></label>
                    <input asp-for="Input.WidthCm" class="form-control" />
                    <span asp-validation-for="Input.WidthCm" class="text-danger"></span>
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="Input.HeightCm"></label>
                    <input asp-for="Input.HeightCm" class="form-control" />
                    <span asp-validation-for="Input.HeightCm" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group">
                <label asp-for="Input.ShippingMethods"></label>
                <input asp-for="Input.ShippingMethods" class="form-control" placeholder="Courier, Parcel locker, Pickup" />
                <span asp-validation-for="Input.ShippingMethods" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-primary">Save changes</button>
            <a asp-page="List" class="btn btn-link">Back to list</a>
        </form>
    </div>
</div>

<partial name="_ValidationScriptsPartial" />
<script>
    (function () {
        const templates = @Html.Raw(Model.AttributeTemplatesJson);
        const selectedValues = @Html.Raw(JsonSerializer.Serialize(Model.Input.AttributeValues ?? new Dictionary<int, string>()));
        const legacyAttributes = @Html.Raw(JsonSerializer.Serialize(Model.LegacyAttributes ?? new Dictionary<string, string>()));
        const container = document.getElementById('category-attributes');
        const categorySelect = document.getElementById('Input_CategoryId');

        function buildInput(attribute) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = attribute.name + (attribute.isRequired ? ' *' : '');
            wrapper.appendChild(label);

            let inputElement;
            if (attribute.type === 'list') {
                inputElement = document.createElement('select');
                inputElement.className = 'form-control';
                inputElement.name = `Input.AttributeValues[${attribute.id}]`;

                const options = (attribute.options || '').split(',').map(o => o.trim()).filter(o => o);
                options.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o;
                    opt.textContent = o;
                    inputElement.appendChild(opt);
                });
            } else {
                inputElement = document.createElement('input');
                inputElement.className = 'form-control';
                inputElement.type = attribute.type === 'number' ? 'number' : 'text';
                inputElement.name = `Input.AttributeValues[${attribute.id}]`;
            }

            if (selectedValues && selectedValues.hasOwnProperty(attribute.id)) {
                inputElement.value = selectedValues[attribute.id] || '';
            }

            wrapper.appendChild(inputElement);
            return wrapper;
        }

        function renderLegacy(containerEl) {
            const keys = Object.keys(legacyAttributes || {});
            if (!keys.length) return;

            const box = document.createElement('div');
            box.className = 'alert alert-info mt-2';
            const title = document.createElement('div');
            title.className = 'fw-semibold mb-1';
            title.textContent = 'Existing attributes (deprecated)';
            box.appendChild(title);

            keys.forEach(k => {
                const row = document.createElement('div');
                row.textContent = `${k}: ${legacyAttributes[k]}`;
                box.appendChild(row);
            });

            containerEl.appendChild(box);
        }

        function renderAttributes() {
            if (!container || !categorySelect) return;
            container.innerHTML = '';

            const selectedCategory = categorySelect.value;
            if (!selectedCategory || !templates[selectedCategory] || templates[selectedCategory].length === 0) {
                container.classList.add('d-none');
                renderLegacy(container);
                return;
            }

            container.classList.remove('d-none');
            const header = document.createElement('h5');
            header.textContent = 'Category attributes';
            container.appendChild(header);

            templates[selectedCategory].forEach(attribute => {
                container.appendChild(buildInput(attribute));
            });

            renderLegacy(container);
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', renderAttributes);
        }

        renderAttributes();
    })();
</script>
